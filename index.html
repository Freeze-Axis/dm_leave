<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Freeze - DMグループ退出ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Cinzel:wght@500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #60a5fa;
      --primary-dark: #3b82f6;
      --primary-light: #93c5fd;
      --secondary-color: #a78bfa;
      --accent-color: #ec4899;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    *, *::before, *::after { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
    }

    html, body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      transition: var(--transition);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header & Navigation */
    header {
      background: var(--card-bg);
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: var(--transition);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
      text-decoration: none;
    }

    .logo img {
      height: 40px;
      width: auto;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    /* Main Content */
    .main-content {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 30px;
      margin: 40px 0;
    }

    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    /* Tool Container */
    .tool-container {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 30px;
      transition: var(--transition);
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .tool-icon {
      font-size: 2.2rem;
      color: var(--primary-color);
    }

    .tool-title {
      font-family: 'Cinzel', serif;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .form-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-dark);
    }

    .section-icon {
      font-size: 1.3rem;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .label-icon {
      font-size: 1rem;
      color: var(--primary-color);
    }

    .input-wrapper {
      position: relative;
      margin-bottom: 15px;
    }

    .form-input {
      width: 100%;
      padding: 14px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-color);
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: var(--transition);
    }

    .form-input:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
    }

    .password-container {
      display: flex;
      align-items: center;
    }

    .password-container input {
      flex: 1;
      padding-right: 45px;
    }

    .toggle-password {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .switch-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 12px 15px;
      background: var(--bg-color);
      border-radius: 8px;
      transition: var(--transition);
    }

    .switch-container:hover {
      background: rgba(96, 165, 250, 0.1);
    }

    .switch-label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #475569;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary-color);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .icon-input-wrapper {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .custom-file-upload {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--primary-color);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: var(--transition);
    }

    .custom-file-upload:hover {
      background: var(--primary-dark);
    }

    .file-icon {
      font-size: 1rem;
    }

    #clearIconBtn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--error-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: var(--transition);
    }

    #clearIconBtn:hover {
      background: #dc2626;
    }

    #iconPreview {
      width: 50px;
      height: 50px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      object-fit: cover;
      background: var(--bg-color);
    }

    .file-status {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-left: 10px;
    }

    .btn-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 25px 0;
    }

    .btn {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      padding: 14px 20px;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      color: white;
      box-shadow: var(--shadow);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--secondary-color), #6d28d9);
      color: white;
      box-shadow: var(--shadow);
    }

    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #6d28d9, var(--secondary-color));
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .btn-stop {
      background: linear-gradient(135deg, var(--error-color), #dc2626);
      color: white;
      box-shadow: var(--shadow);
    }

    .btn-stop:hover {
      background: linear-gradient(135deg, #dc2626, var(--error-color));
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .status-container {
      margin-top: 30px;
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .status-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .clear-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.9rem;
      transition: var(--transition);
    }

    .clear-btn:hover {
      color: var(--error-color);
    }

    .status-box {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Roboto Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .status-line {
      margin-bottom: 8px;
      /* padding-left: 20px; 削除可 */
      /* position: relative; 削除可 */
    }

    .status-success {
      color: var(--success-color);
    }

    .status-error {
      color: var(--error-color);
    }

    .status-warning {
      color: var(--warning-color);
    }

    .status-info {
      color: var(--primary-color);
    }

    /* Info Panel */
    .info-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 25px;
      transition: var(--transition);
    }

    .panel-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .panel-icon {
      font-size: 1.8rem;
      color: var(--primary-color);
    }

    .panel-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .info-item {
      margin-bottom: 20px;
    }

    .info-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .info-icon {
      font-size: 1.2rem;
      color: var(--primary-color);
    }

    .info-content {
      color: var(--text-secondary);
      font-size: 0.95rem;
      line-height: 1.6;
      padding-left: 28px;
    }

    .progress-container {
      margin: 25px 0;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-color);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Footer */
    .footer {
      text-align: center;
      padding: 25px 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
      margin-top: 40px;
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header-content {
        padding: 12px 0;
      }
      
      .logo {
        font-size: 1.5rem;
      }
      
      .logo img {
        height: 32px;
      }
      
      .tool-container, .info-panel {
        padding: 20px;
      }
      
      .btn-group {
        grid-template-columns: 1fr;
      }
      
      .tool-title {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0 15px;
      }
      
      .tool-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .icon-input-wrapper {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="#" class="logo">
          <img src="https://i.ibb.co/39dXLvV3/Freeze-logo.png" alt="Freeze Logo">
          <span>Freeze</span>
        </a>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="main-content">
      <div class="tool-container">
        <div class="tool-header">
          <i class="fas fa-comments tool-icon"></i>
          <h1 class="tool-title">DMグループ退出ツール</h1>
        </div>

        <form id="leaveForm">
          <div class="form-section">
            <h2 class="section-title">
              <i class="fas fa-key section-icon"></i>
              認証情報
            </h2>
            
            <div class="form-group">
              <label for="token" class="form-label">
                <i class="fas fa-fingerprint label-icon"></i>
                Discord Token
              </label>
              <div class="input-wrapper">
                <div class="password-container">
                  <input type="password" id="token" class="form-input" placeholder="トークンを入力してください" autocomplete="off">
                  <button type="button" class="toggle-password" id="toggleToken">
                    <i class="far fa-eye"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h2 class="section-title">
              <i class="fas fa-sliders-h section-icon"></i>
              退出設定
            </h2>
            
            <div class="form-group" id="limitGroup">
              <label for="limit" class="form-label">
                <i class="fas fa-hashtag label-icon"></i>
                退出するグループ数
              </label>
              <input type="number" id="limit" class="form-input" placeholder="空欄の場合はすべてのグループを退出します" min="1">
            </div>

            <div class="switch-container">
              <label class="switch-label">
                <i class="fas fa-users"></i>
                全てのグループを退出
              </label>
              <label class="switch">
                <input type="checkbox" id="leaveAllGroups">
                <span class="slider"></span>
              </label>
            </div>

            <div class="switch-container">
              <label class="switch-label">
                <i class="fas fa-crown"></i>
                自分が作成者でないグループのみ退出
              </label>
              <label class="switch">
                <input type="checkbox" id="nonOwnerLeave">
                <span class="slider"></span>
              </label>
            </div>

            <div class="switch-container">
              <label class="switch-label">
                <i class="fas fa-bell"></i>
                退出通知を残す
              </label>
              <label class="switch">
                <input type="checkbox" id="leaveNotifySwitch" checked>
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="form-section">
            <h2 class="section-title">
              <i class="fas fa-pencil-alt section-icon"></i>
              グループ設定（オプション）
            </h2>
            
            <div class="form-group">
              <label for="newGroupName" class="form-label">
                <i class="fas fa-tag label-icon"></i>
                新しいグループ名
              </label>
              <input type="text" id="newGroupName" class="form-input" placeholder="退出前にグループ名を変更します">
            </div>

            <div class="form-group">
              <label class="form-label">
                <i class="fas fa-image label-icon"></i>
                グループアイコン
              </label>
              <div class="icon-input-wrapper">
                <label class="custom-file-upload">
                  <i class="fas fa-upload file-icon"></i>
                  画像を選択
                  <input type="file" id="newIconFile" accept="image/*">
                </label>
                <span class="file-status" id="fileStatus">選択されていません</span>
                <button type="button" id="clearIconBtn" style="display: none;">
                  <i class="fas fa-trash"></i>
                  削除
                </button>
                <img id="iconPreview" alt="アイコンプレビュー" style="display: none;">
              </div>
            </div>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-secondary" id="checkGroupCountBtn">
              <i class="fas fa-list"></i>
              グループ数確認
            </button>
            <button type="button" class="btn btn-primary" id="executeBtn">
              <i class="fas fa-play"></i>
              実行
            </button>
          </div>
        </form>

        <div class="status-container">
          <div class="status-header">
            <h3 class="status-title">処理ステータス</h3>
            <button class="clear-btn" id="clearStatusBtn">
              <i class="fas fa-trash-alt"></i>
              クリア
            </button>
          </div>
          <div class="status-box" id="message"></div>
        </div>
      </div>

      <div class="info-panel">
        <div class="panel-header">
          <i class="fas fa-info-circle panel-icon"></i>
          <h2 class="panel-title">情報パネル</h2>
        </div>

        <div class="info-item">
          <h3 class="info-title">
            <i class="fas fa-tachometer-alt info-icon"></i>
            進捗状況
          </h3>
          <div class="progress-container">
            <div class="progress-info">
              <span>処理中: <span id="processedCount">0</span></span>
              <span>合計: <span id="totalCount">0</span></span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="info-item">
          <h3 class="info-title">
            <i class="fas fa-check-circle info-icon"></i>
            ステータス概要
          </h3>
          <div class="info-content">
            <p><i class="fas fa-check status-success"></i> 成功: <span id="successCount">0</span></p>
            <p><i class="fas fa-times status-error"></i> 失敗: <span id="errorCount">0</span></p>
            <p><i class="fas fa-clock status-info"></i> 残り: <span id="remainingCount">0</span></p>
          </div>
        </div>

        <div class="info-item">
          <h3 class="info-title">
            <i class="fas fa-lightbulb info-icon"></i>
            使い方
          </h3>
          <div class="info-content">
            <p>1. Discordトークンを入力します</p>
            <p>2. 退出設定を調整します</p>
            <p>3. 「グループ数確認」で現在の状態を確認</p>
            <p>4. 「実行」をクリックして処理を開始</p>
          </div>
        </div>

        <div class="info-item">
          <h3 class="info-title">
            <i class="fas fa-shield-alt info-icon"></i>
            セキュリティ情報
          </h3>
          <div class="info-content">
            <p>• トークンはブラウザにのみ保存されます</p>
            <p>• 外部サーバーに送信されることはありません</p>
            <p>• 処理はすべてクライアント側で実行されます</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p id="footerCopyright"></p>
    </div>
  </footer>

  <script>
  // フッター年自動表示
  document.getElementById("footerCopyright").textContent = `Freeze - DMグループ退出ツール © ${new Date().getFullYear()}`;

  // DOM 要素取得
    const tokenInput = document.getElementById("token");
    const toggleTokenBtn = document.getElementById("toggleToken");
    const limitInput = document.getElementById("limit");
    const nonOwnerCB = document.getElementById("nonOwnerLeave");
    const newNameInput = document.getElementById("newGroupName");
    const fileInput = document.getElementById("newIconFile");
    const clearBtn = document.getElementById("clearIconBtn");
    const iconPreview = document.getElementById("iconPreview");
    const leaveNotifySwitch = document.getElementById("leaveNotifySwitch");
    const checkBtn = document.getElementById("checkGroupCountBtn");
    const execBtn = document.getElementById("executeBtn");
    const msgBox = document.getElementById("message");
    const leaveAllGroups = document.getElementById("leaveAllGroups");
    const limitGroup = document.getElementById("limitGroup");
    const clearStatusBtn = document.getElementById("clearStatusBtn");
    const fileStatus = document.getElementById("fileStatus");
    
    // 進捗表示用要素
    const processedCount = document.getElementById("processedCount");
    const totalCount = document.getElementById("totalCount");
    const progressFill = document.getElementById("progressFill");
    const successCount = document.getElementById("successCount");
    const errorCount = document.getElementById("errorCount");
    const remainingCount = document.getElementById("remainingCount");

    // トークン表示切り替え
    toggleTokenBtn.addEventListener("click", () => {
      if (tokenInput.type === "password") {
        tokenInput.type = "text";
        toggleTokenBtn.innerHTML = '<i class="far fa-eye-slash"></i>';
      } else {
        tokenInput.type = "password";
        toggleTokenBtn.innerHTML = '<i class="far fa-eye"></i>';
      }
    });

    // ステータス表示関数
    function addStatusMessage(message, type = "") {
      const p = document.createElement("p");
      p.className = `status-line ${type ? 'status-' + type : ''}`;
      p.innerHTML = `<i class="fas ${getStatusIcon(type)}"></i> ${message}`;
      // 追加前に一番下までスクロールされているか判定
      const isAtBottom = (msgBox.scrollTop + msgBox.clientHeight) >= (msgBox.scrollHeight - 2);
      msgBox.appendChild(p);
      // 一番下までスクロールされていた場合のみ自動スクロール
      if (isAtBottom) {
        msgBox.scrollTop = msgBox.scrollHeight;
      }
    }

    // ステータスタイプに応じたアイコンを取得
    function getStatusIcon(type) {
      switch(type) {
        case "success": return "fa-check-circle";
        case "error": return "fa-times-circle";
        case "warning": return "fa-exclamation-triangle";
        default: return "fa-info-circle";
      }
    }

    // 進捗状況の更新
    function updateProgress(current, total, successes, errors) {
      processedCount.textContent = current;
      totalCount.textContent = total;
      successCount.textContent = successes;
      errorCount.textContent = errors;
      remainingCount.textContent = total - current;
      
      const progressPercent = total > 0 ? (current / total) * 100 : 0;
      progressFill.style.width = `${progressPercent}%`;
    }

    // 設定保存
    function saveSettings() {
      localStorage.setItem("token", tokenInput.value);
      localStorage.setItem("limit", limitInput.value);
      localStorage.setItem("nonOwner", nonOwnerCB.checked);
      localStorage.setItem("newName", newNameInput.value);
      localStorage.setItem("leaveNotify", leaveNotifySwitch.checked);
      localStorage.setItem("leaveAllGroups", leaveAllGroups.checked);
    }

    // 入力イベントリスナー
    [tokenInput, limitInput, newNameInput].forEach(el => {
      el.addEventListener("input", saveSettings);
    });
    
    [nonOwnerCB, leaveNotifySwitch, leaveAllGroups].forEach(el => {
      el.addEventListener("change", saveSettings);
    });
    
    leaveAllGroups.addEventListener("change", function() {
      saveSettings();
      limitGroup.style.display = this.checked ? "none" : "block";
    });

    // ステータスクリア
    clearStatusBtn.addEventListener("click", () => {
      msgBox.innerHTML = "";
    });

    // アイコンプレビュー更新
    function updateIconUI() {
      const data = localStorage.getItem("newIconData");
      if (data) {
        iconPreview.src = data;
        iconPreview.style.display = "block";
        clearBtn.style.display = "flex";
        fileStatus.style.display = "none";
      } else {
        iconPreview.style.display = "none";
        clearBtn.style.display = "none";
        fileStatus.style.display = "inline";
      }
    }

    // Base64 変換ユーティリティ
    function readFileAsDataURL(file) {
      return new Promise((res, rej) => {
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    // ページロード時の設定復元
    window.addEventListener("load", () => {
      tokenInput.value = localStorage.getItem("token") || "";
      limitInput.value = localStorage.getItem("limit") || "";
      nonOwnerCB.checked = localStorage.getItem("nonOwner") === "true";
      newNameInput.value = localStorage.getItem("newName") || "";
      leaveNotifySwitch.checked = localStorage.getItem("leaveNotify") !== "false";
      leaveAllGroups.checked = localStorage.getItem("leaveAllGroups") === "true";
      
      // アイコンデータの復元
      const iconData = localStorage.getItem("newIconData");
      if (iconData) {
        iconPreview.src = iconData;
        iconPreview.style.display = "block";
        clearBtn.style.display = "flex";
        fileStatus.style.display = "none";
      } else {
        iconPreview.style.display = "none";
        clearBtn.style.display = "none";
        fileStatus.style.display = "inline";
      }
      
      // グループ数入力欄の表示制御
      limitGroup.style.display = leaveAllGroups.checked ? "none" : "block";
    });

    // ファイル選択処理
    fileInput.addEventListener("change", async () => {
      if (fileInput.files[0]) {
        try {
          const dataUrl = await readFileAsDataURL(fileInput.files[0]);
          localStorage.setItem("newIconData", dataUrl);
          iconPreview.src = dataUrl;
          iconPreview.style.display = "block";
          clearBtn.style.display = "flex";
          fileStatus.style.display = "none";
          addStatusMessage("アイコンが設定されました", "success");
        } catch (error) {
          addStatusMessage("アイコンの読み込みに失敗しました", "error");
        }
      }
    });

    // アイコン削除処理
    clearBtn.addEventListener("click", () => {
      localStorage.removeItem("newIconData");
      fileInput.value = "";
      iconPreview.style.display = "none";
      clearBtn.style.display = "none";
      fileStatus.style.display = "inline";
      addStatusMessage("アイコン設定を削除しました");
    });

    // ボタンの状態管理
    function setButtonsState(enabled) {
  checkBtn.disabled = !enabled;
  // 実行中は停止ボタンを押せるようにする
  if (isProcessing) {
    execBtn.disabled = false;
  } else {
    execBtn.disabled = !enabled;
  }
  nonOwnerCB.disabled = !enabled;
  newNameInput.disabled = !enabled;
  fileInput.disabled = !enabled;
  tokenInput.disabled = !enabled;
  limitInput.disabled = !enabled;
  leaveNotifySwitch.disabled = !enabled;
  leaveAllGroups.disabled = !enabled;
  // execBtnの表示切り替えはイベントハンドラ側でのみ行う
    }

    // グループ数確認
    checkBtn.addEventListener("click", async () => {
      msgBox.innerHTML = "";
      const token = tokenInput.value.trim();
      if (!token) {
        addStatusMessage("Tokenを入力してください", "error");
        return;
      }

      setButtonsState(false);
      addStatusMessage("グループ情報を取得中...", "info");

      try {
        const res = await fetch("https://discord.com/api/v9/users/@me/channels", {
          headers: { Authorization: token }
        });

        if (!res.ok) {
          const error = await res.json();
          addStatusMessage(`取得失敗: ${error.message || res.status}`, "error");
          return;
        }

        const channels = await res.json();
        const groups = channels.filter(c => c.type === 3);

        // ユーザー情報取得
        let me = null;
        try {
          const ures = await fetch("https://discord.com/api/v9/users/@me", {
            headers: { Authorization: token }
          });
          if (ures.ok) {
            me = await ures.json();
          }
        } catch {}

        let ownerGroups = [];
        let nonOwnerGroups = [];
        if (me) {
          ownerGroups = groups.filter(g => g.owner_id === me.id);
          nonOwnerGroups = groups.filter(g => g.owner_id !== me.id);
        }

        addStatusMessage(`現在 ${groups.length} 件のグループDMに参加中`, "success");
        addStatusMessage(`├─ あなたが作成者: ${ownerGroups.length}件`);
        addStatusMessage(`└─ 他人が作成者: ${nonOwnerGroups.length}件`);
      } catch (error) {
        addStatusMessage("ネットワークエラー: " + error.message, "error");
      } finally {
        setButtonsState(true);
      }
    });

    // 実行／停止制御
    let abortController = null;
    let isProcessing = false;

    execBtn.addEventListener("click", async () => {
      // 停止処理
      if (isProcessing) {
        if (abortController) {
          abortController.abort();
          addStatusMessage("処理を中断しています...", "warning");
          isProcessing = false;
          execBtn.innerHTML = '<i class="fas fa-play"></i> 実行';
          execBtn.className = 'btn btn-primary';
          setButtonsState(true);
        }
        return;
      }

      // 実行処理
      isProcessing = true;
      msgBox.innerHTML = "";
      execBtn.innerHTML = '<i class="fas fa-stop"></i> 停止';
      execBtn.className = 'btn btn-stop';
      setButtonsState(false);
      abortController = new AbortController();
      const signal = abortController.signal;

      const token = tokenInput.value.trim();
      if (!token) {
        addStatusMessage("Tokenを入力してください", "error");
        resetUI();
        return;
      }

      try {
        // ユーザー情報取得
        addStatusMessage("ユーザー情報を確認中...", "info");
        const ures = await fetch("https://discord.com/api/v9/users/@me", {
          headers: { Authorization: token },
          signal
        });

        if (!ures.ok) {
          const error = await ures.json();
          addStatusMessage(`エラー: ${error.message || "無効なTokenです"}`, "error");
          return;
        }

  const me = await ures.json();
  // 「グローバルネーム（ユーザーネーム）」の形で表示
  const globalName = me.global_name || "";
  const userName = me.username || "";
  addStatusMessage(`ユーザー: ${globalName}（${userName}）`, "success");

        // DM一覧取得
        addStatusMessage("グループ一覧を取得中...", "info");
        const cres = await fetch("https://discord.com/api/v9/users/@me/channels", {
          headers: { Authorization: token },
          signal
        });

        if (!cres.ok) {
          const error = await cres.json();
          addStatusMessage(`取得失敗: ${error.message || cres.status}`, "error");
          return;
        }

        const channels = await cres.json();
        addStatusMessage(`取得完了: ${channels.length}件のチャンネル`, "success");

        let groups = channels.filter(c => c.type === 3);
        const orig = groups.length;
        addStatusMessage(`グループDM: ${orig}件`);

        // フィルタリング
        if (nonOwnerCB.checked) {
          groups = groups.filter(c => c.owner_id !== me.id);
          addStatusMessage(`他人が作成したグループ: ${groups.length}件`);
        }

        // 件数制限
        if (limitInput.value && !leaveAllGroups.checked) {
          const n = parseInt(limitInput.value, 10);
          if (!isNaN(n) && n > 0) {
            groups = groups.slice(0, n);
            addStatusMessage(`退出対象: ${groups.length}件 (制限適用)`, "info");
          }
        } else {
          addStatusMessage(`退出対象: ${groups.length}件`);
        }

        if (groups.length === 0) {
          addStatusMessage("処理対象のグループがありません", "warning");
          return;
        }

        // 進捗表示の初期化
        updateProgress(0, groups.length, 0, 0);

        // アイコン設定
        let iconData = localStorage.getItem("newIconData") || null;
        const newName = newNameInput.value.trim();

        // グループ処理ループ
        let successCount = 0;
        let errorCount = 0;

        let processed = 0;
        let aborted = false;
        for (const [index, ch] of groups.entries()) {
          if (signal.aborted) {
            aborted = true;
            break;
          }

          addStatusMessage(`[${processed + 1}/${groups.length}] グループ処理中: ${ch.id}`, "info");

          // グループ情報更新
          if (newName || iconData) {
            try {
              const body = {};
              if (newName) body.name = newName;
              if (iconData) body.icon = iconData;

              addStatusMessage("グループ情報を更新中...");
              const upRes = await fetch(`https://discord.com/api/v9/channels/${ch.id}`, {
                method: "PATCH",
                headers: {
                  Authorization: token,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(body),
                signal
              });

              if (upRes.ok) {
                addStatusMessage("グループ情報を更新しました", "success");
              } else {
                const error = await upRes.json();
                addStatusMessage(`更新失敗: ${error.message || upRes.status}`, "error");
                errorCount++;
                processed++;
                updateProgress(successCount + errorCount, groups.length, successCount, errorCount);
                continue;
              }
            } catch (error) {
              if (error.name === "AbortError") {
                aborted = true;
                break;
              }
              addStatusMessage(`更新エラー: ${error.message}`, "error");
              errorCount++;
              processed++;
              updateProgress(successCount + errorCount, groups.length, successCount, errorCount);
              continue;
            }
          }

          // グループ退出
          try {
            const silentParam = leaveNotifySwitch.checked ? "" : "?silent=true";
            addStatusMessage("グループから退出中...");
            const lr = await fetch(
              `https://discord.com/api/v9/channels/${ch.id}${silentParam}`, {
                method: "DELETE",
                headers: { Authorization: token },
                signal
              }
            );

            if (lr.ok) {
              addStatusMessage("グループから退出しました", "success");
              successCount++;
            } else {
              const error = await lr.json();
              addStatusMessage(`退出失敗: ${error.message || lr.status}`, "error");
              errorCount++;
            }
            processed++;
            updateProgress(successCount + errorCount, groups.length, successCount, errorCount);
          } catch (error) {
            if (error.name === "AbortError") {
              aborted = true;
              break;
            }
            addStatusMessage(`退出エラー: ${error.message}`, "error");
            errorCount++;
            processed++;
            updateProgress(successCount + errorCount, groups.length, successCount, errorCount);
          }
        }

        // 完全停止：中断時はその時点で進捗・件数表示を止める
        updateProgress(successCount + errorCount, groups.length, successCount, errorCount);
        if (aborted) {
          addStatusMessage("処理が中断されました", "warning");
        }
        addStatusMessage(`処理完了: ${successCount}件成功, ${errorCount}件失敗`, 
                         errorCount === 0 ? "success" : "warning");
      } catch (error) {
        if (error.name === "AbortError") {
          addStatusMessage("処理が中断されました", "warning");
        } else {
          addStatusMessage(`エラー: ${error.message}`, "error");
        }
      } finally {
        resetUI();
      }
    });

    // UI状態リセット
    function resetUI() {
  isProcessing = false;
  execBtn.innerHTML = '<i class="fas fa-play"></i> 実行';
  execBtn.className = 'btn btn-primary';
  setButtonsState(true);
  abortController = null;
    }
  </script>
</body>
</html>